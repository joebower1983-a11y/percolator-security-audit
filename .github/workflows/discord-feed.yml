name: Discord Feed

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, closed]
  issues:
    types: [opened, closed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Push notification
        if: github.event_name == 'push'
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          AUTHOR: ${{ github.event.sender.login }}
          COMPARE: ${{ github.event.compare }}
          SHA: ${{ github.event.after }}
          COMMIT_COUNT: ${{ github.event.size }}
        run: |
          SHORT_SHA=$(echo "$SHA" | cut -c1-7)
          MSG=$(echo "$COMMIT_MSG" | head -1 | cut -c1-80)
          
          jq -n \
            --arg desc "[\`$SHORT_SHA\`]($COMPARE) $MSG" \
            --arg author "${AUTHOR:-unknown}" \
            --arg icon "https://github.com/${AUTHOR:-ghost}.png?size=32" \
            --arg footer "${COMMIT_COUNT:-1} commit(s) to main" \
            '{embeds: [{color: 5025616, author: {name: $author, icon_url: $icon}, description: $desc, footer: {text: $footer}}]}' > /tmp/payload.json
          
          curl -s -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @/tmp/payload.json

      - name: PR notification
        if: github.event_name == 'pull_request'
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ACTION: ${{ github.event.action }}
          MERGED: ${{ github.event.pull_request.merged }}
          PR_NUM: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          AUTHOR: ${{ github.event.pull_request.user.login }}
          ADDS: ${{ github.event.pull_request.additions }}
          DELS: ${{ github.event.pull_request.deletions }}
          FILES: ${{ github.event.pull_request.changed_files }}
        run: |
          if [ "$ACTION" = "opened" ]; then
            COLOR=3447003; STATUS="PR opened"
          elif [ "$ACTION" = "closed" ] && [ "$MERGED" = "true" ]; then
            COLOR=5025616; STATUS="PR merged"
          elif [ "$ACTION" = "closed" ]; then
            COLOR=10038562; STATUS="PR closed"
          else
            exit 0
          fi
          
          TITLE=$(echo "$PR_TITLE" | cut -c1-80)
          
          jq -n \
            --argjson color "$COLOR" \
            --arg desc "[#$PR_NUM]($PR_URL) $TITLE â€” +$ADDS -$DELS ($FILES files)" \
            --arg author "$AUTHOR" \
            --arg icon "https://github.com/$AUTHOR.png?size=32" \
            --arg footer "$STATUS" \
            '{embeds: [{color: $color, author: {name: $author, icon_url: $icon}, description: $desc, footer: {text: $footer}}]}' > /tmp/payload.json
          
          curl -s -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @/tmp/payload.json

      - name: Issue notification
        if: github.event_name == 'issues'
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          ACTION: ${{ github.event.action }}
          ISSUE_NUM: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          if [ "$ACTION" = "opened" ]; then
            COLOR=15105570; STATUS="Issue opened"
          else
            COLOR=8421504; STATUS="Issue closed"
          fi
          
          TITLE=$(echo "$ISSUE_TITLE" | cut -c1-80)
          
          jq -n \
            --argjson color "$COLOR" \
            --arg desc "[#$ISSUE_NUM]($ISSUE_URL) $TITLE" \
            --arg author "$AUTHOR" \
            --arg icon "https://github.com/$AUTHOR.png?size=32" \
            --arg footer "$STATUS" \
            '{embeds: [{color: $color, author: {name: $author, icon_url: $icon}, description: $desc, footer: {text: $footer}}]}' > /tmp/payload.json
          
          curl -s -X POST "$WEBHOOK" -H "Content-Type: application/json" -d @/tmp/payload.json
